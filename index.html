<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
    <style>
        #mapid { 
            height: 100%;
            margin: 10px;
        }
        #coords {
            width: 50%;
            height: 30px;
        }
        button {
            height: 30px;
        }
    </style>
  </head>
  <body>
    <input type="text" name="coords" id="coords" placeholder="Enter the coordinates of the location">
    <button onclick="Search()">Search</button>
    <div id="mapid"></div>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>
        var mymap = L.map('mapid').setView([25.5357, 84.8512], 13);

        L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(mymap);

        // Ask for current location and navigate to that area
        const options = {
            enableHighAccuracy: true, 
            // Get high accuracy reading, if available (default false)
            timeout: 5000, 
            // Time to return a position successfully before error (default infinity)
            maximumAge: 2000, 
            // Milliseconds for which it is acceptable to use cached position (default 0)
        };
        navigator.geolocation.getCurrentPosition(success);
        setInterval(()=>{
            navigator.geolocation.getCurrentPosition(success);
        }, 2000);
        // Fires success function immediately and when user position changes
        // https://ev-v2.cc.api.here.com/ev/stations.json?prox=52.516667,13.383333,5000&connectortype=31&apiKey={0wzYFlxxuawzSm56H5j9TbqcOiFla5iR52X2MefIWXA}
        var marker;
        var lati;
        var long;
        function success(pos) {

            lati = pos.coords.latitude;
            long = pos.coords.longitude;
            const accuracy = pos.coords.accuracy;
            // console.log(accuracy);
            if (marker)
            {
                mymap.removeLayer(marker);
            }
            marker = L.marker([lati, long]).addTo(mymap);
            marker.bindPopup("Current Location");
        }

        function error(err) {

            if (err.code === 1) {
                alert("Please allow geolocation access");
                // Runs if user refuses access
            }
        }

        var dest;
        var rout;
        var redIcon = new L.Icon({
            iconUrl: 'img/marker-icon-red.png',
            shadowUrl: 'img/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        mymap.on('click', function(e) {
            if (dest)
            {
                mymap.removeLayer(dest);
                mymap.removeControl(rout);
            }
            
            rout = L.Routing.control({
                        waypoints: [
                            L.latLng(lati, long),
                            L.latLng(e.latlng.lat, e.latlng.lng)
                        ]
            }).addTo(mymap);
            dest = L.marker([e.latlng.lat, e.latlng.lng], {icon: redIcon}).addTo(mymap);
            dest.bindPopup("Destination Latitude: " + e.latlng.lat + "<br>Destination Longitude: " + e.latlng.lng);
        });
        function Search() {
            const val=document.getElementById("coords").value;
            var latlng = val.split(',');
            var lat = latlng[0];
            lat = lat.trim();
            var lng = latlng[1];
            lng = lng.trim();
            if (dest)
            {
                mymap.removeLayer(dest);
                mymap.removeControl(rout);
            }
            
            rout = L.Routing.control({
                        waypoints: [
                            L.latLng(lati, long),
                            L.latLng(lat, lng)
                        ]
            }).addTo(mymap);
            dest = L.marker([lat, lng], {icon: redIcon}).addTo(mymap);
            dest.bindPopup("Destination Latitude: " + lat + "<br>Destination Longitude: " + lng);
            document.getElementById("coords").value = "";
        }
        const apiKey = "b8d077af-f680-43f2-b80a-329bd6831d84";
        var api_url=`https://api.openchargemap.io/v3/poi/?output=json&latitude=${lati}&longitude=${long}&distance=10&distanceunit=KM&CountryCode=IN&maxresults=100&key=${apiKey}`;
        fetch(api_url)
            .then(response => response.json())
            .then(res => {
                if(res.length > 0) {
                    if (dest)
                    {
                        mymap.removeLayer(dest);
                        mymap.removeControl(rout);
                    }

                    // rout = L.Routing.control({
                    //     waypoints: [
                    //         L.latLng(lati, long),
                    //         L.latLng(res[35].AddressInfo.Latitude, res[35].AddressInfo.Longitude)
                    //     ]
                    // }).addTo(mymap);
                    for(var i=0; i<res.length; i++) {
                        L.marker([res[i].AddressInfo.Latitude, res[i].AddressInfo.Longitude], {icon: redIcon}).addTo(mymap);
                    }
                }
                else {
                    console.log('failed')
                }
                
            });
            const openRouteServiceApiKey = "5b3ce3597851110001cf6248e4691fe883834ea88263486e70d3c838";

const startCoordinates = {
  lat: 57.74,
  lng: 11.94
};

const endCoordinates = {
  lat: 51.50,
  lng: -0.12
};

const route = await openrouteservice.route({
  coordinates: [startCoordinates, endCoordinates],
  profile: "driving",
  apiKey: openRouteServiceApiKey
});

const distance = route.routes[0].distance;
console.log(distance)


    </script>
  </body>
</html>