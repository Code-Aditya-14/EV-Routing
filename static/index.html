<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
    <style>
        #mapid { 
            height: 100%;
            margin: 10px;
        }
        #coords {
            width: 50%;
            height: 30px;
        }
        button {
            height: 30px;
        }
    </style>
  </head>
  <body>
    <!-- <input type="text" name="coords" id="coords" placeholder="Enter the coordinates of the location">
    <button onclick="Search()">Search</button> -->
    <div id="mapid"></div>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>
        var mymap = L.map('mapid').setView([25.5357, 84.8512], 13);

        L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
            maxZoom: 20,
            subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(mymap);

        // Ask for current location and navigate to that area
        const options = {
            enableHighAccuracy: true, 
            // Get high accuracy reading, if available (default false)
            timeout: 5000, 
            // Time to return a position successfully before error (default infinity)
            maximumAge: 2000, 
            // Milliseconds for which it is acceptable to use cached position (default 0)
        };
        navigator.geolocation.getCurrentPosition(success);
        setInterval(()=>{
            navigator.geolocation.getCurrentPosition(success);
        }, 2000);
        // Fires success function immediately and when user position changes
        // https://ev-v2.cc.api.here.com/ev/stations.json?prox=52.516667,13.383333,5000&connectortype=31&apiKey={0wzYFlxxuawzSm56H5j9TbqcOiFla5iR52X2MefIWXA}
        var marker;
        var lati;
        var long;
        function success(pos) {

            lati = pos.coords.latitude;
            long = pos.coords.longitude;
            const accuracy = pos.coords.accuracy;
            // console.log(accuracy);
            if (marker)
            {
                mymap.removeLayer(marker);
            }
            marker = L.marker([lati, long]).addTo(mymap);
            marker.bindPopup("Current Location");
        }

        function error(err) {

            if (err.code === 1) {
                alert("Please allow geolocation access");
                // Runs if user refuses access
            }
        }

        var dest;
        var dest1;
        var dest2;
        var dest3;
        var dest4;
        var dest5;
        var dest6;
        var dest7;
        var dest8;
        var dest9;
        var rout;
        var redIcon = new L.Icon({
            iconUrl: 'img/marker-icon-red.png',
            shadowUrl: 'img/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
        mymap.on('click', function(e) {
            if (dest)
            {
                mymap.removeLayer(dest);
                mymap.removeLayer(dest1);
                mymap.removeLayer(dest2);
                mymap.removeLayer(dest3);
                mymap.removeLayer(dest4);
                mymap.removeLayer(dest5);
                mymap.removeLayer(dest6);
                mymap.removeLayer(dest7);
                mymap.removeLayer(dest8);
                mymap.removeLayer(dest9);
                mymap.removeControl(rout);
            }
            
            rout = L.Routing.control({
                        waypoints: [
                            L.latLng(lati, long),
                            L.latLng(e.latlng.lat, e.latlng.lng)
                        ]
            }).addTo(mymap);
            dest = L.marker([e.latlng.lat, e.latlng.lng], {icon: redIcon}).addTo(mymap);
            dest.bindPopup("Destination Latitude: " + e.latlng.lat + "<br>Destination Longitude: " + e.latlng.lng);
        });
        function Search() {
            const val=document.getElementById("coords").value;
            var latlng = val.split(',');
            var lat = latlng[0];
            lat = lat.trim();
            var lng = latlng[1];
            lng = lng.trim();
            if (dest)
            {
                mymap.removeLayer(dest);
                mymap.removeControl(rout);
            }
            
            rout = L.Routing.control({
                        waypoints: [
                            L.latLng(lati, long),
                            L.latLng(lat, lng)
                        ]
            }).addTo(mymap);
            dest = L.marker([lat, lng], {icon: redIcon}).addTo(mymap);
            dest.bindPopup("Destination Latitude: " + lat + "<br>Destination Longitude: " + lng);
            document.getElementById("coords").value = "";
        }
        const apiKey = "b8d077af-f680-43f2-b80a-329bd6831d84";
        var api_url=`https://api.openchargemap.io/v3/poi/?output=json&distance=10&distanceunit=KM&CountryCode=IN&maxresults=100&key=${apiKey}`;
        async function getInfo() {
            const resp = await fetch(api_url);
            const obj = await resp.json();
            if(obj.length > 0) {
                var mn=1000000000;
                var idx=0;
                let v = [36, 0, 35, 25, 32, 42, 60, 12, 14, 10]; 
                if (dest)
                {
                    mymap.removeLayer(dest);
                    mymap.removeControl(rout);
                }
                rout = L.Routing.control({
                        waypoints: [
                            L.latLng(lati, long),
                            L.latLng(obj[v[0]].AddressInfo.Latitude, obj[v[0]].AddressInfo.Longitude)
                        ]
                }).addTo(mymap);
                dest = L.marker([obj[v[0]].AddressInfo.Latitude, obj[v[0]].AddressInfo.Longitude], {icon: redIcon}).addTo(mymap);
                dest1 = L.marker([obj[v[1]].AddressInfo.Latitude, obj[v[1]].AddressInfo.Longitude], {icon: redIcon}).addTo(mymap);
                dest2 = L.marker([obj[v[2]].AddressInfo.Latitude, obj[v[2]].AddressInfo.Longitude], {icon: redIcon}).addTo(mymap);
                dest3 = L.marker([obj[v[3]].AddressInfo.Latitude, obj[v[3]].AddressInfo.Longitude], {icon: redIcon}).addTo(mymap);
                dest4 = L.marker([obj[v[4]].AddressInfo.Latitude, obj[v[4]].AddressInfo.Longitude], {icon: redIcon}).addTo(mymap);
                dest5 = L.marker([obj[v[5]].AddressInfo.Latitude, obj[v[5]].AddressInfo.Longitude], {icon: redIcon}).addTo(mymap);
                dest6 = L.marker([obj[v[6]].AddressInfo.Latitude, obj[v[6]].AddressInfo.Longitude], {icon: redIcon}).addTo(mymap);
                dest7 = L.marker([obj[v[7]].AddressInfo.Latitude, obj[v[7]].AddressInfo.Longitude], {icon: redIcon}).addTo(mymap);
                dest8 = L.marker([obj[v[8]].AddressInfo.Latitude, obj[v[8]].AddressInfo.Longitude], {icon: redIcon}).addTo(mymap);
                dest9 = L.marker([obj[v[9]].AddressInfo.Latitude, obj[v[9]].AddressInfo.Longitude], {icon: redIcon}).addTo(mymap);
            }
        }
        getInfo();
    </script>
  </body>
</html>